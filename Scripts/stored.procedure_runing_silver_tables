CREATE OR ALTER PROCEDURE silver.load_tables AS
BEGIN

PRINT 'Truncating table Silver.cust_id_info'
TRUNCATE TABLE Silver.cust_id_info
PRINT ' Inserting Data Into Table : Silver.cust_id_info'

INSERT INTO Silver.cust_id_info(
customer_id,
customer_key,
customer_first_name,
customer_last_name,
customer_martial_status,
gender,
create_date
)
SELECT 
customer_id,
customer_key,
TRIM(customer_first_name) as customer_first_name,
TRIM(customer_last_name) as customer_last_name,
CASE 
	WHEN UPPER(TRIM(customer_martial_status)) = 'S' THEN 'Single'
	WHEN UPPER(TRIM(customer_martial_status)) = 'M' THEN 'Married'
	ELSE 'n/a' END
	as martial_status,
CASE 
	WHEN UPPER(TRIM(gender)) = 'F' THEN 'Female'
	WHEN UPPER(TRIM(gender)) = 'M' THEN 'Male'
	ELSE 'n/a' END
	as gender,
create_date
FROM(
SELECT *,
ROW_NUMBER() OVER(PARTITION BY customer_id ORDER BY create_date DESC) as flag
FROM bronze.cust_id_info) t
WHERE flag = 1 


PRINT 'Truncating table Silver.cust_prd_info'
TRUNCATE TABLE Silver.cust_prd_info
PRINT ' Inserting Data Into Table : Silver.cust_prd_info'


INSERT INTO Silver.cust_prd_info (
prd_id,
cat_id,
prd_key,
prd_num,
prd_cost,
prd_line,
prd_start_dt,
prd_end_dt
)
SELECT 
    prd_id,
    REPLACE(SUBSTRING(prd_key,1,5),'-','_') AS cat_id,
    SUBSTRING(prd_key,7,LEN(prd_key)) AS prd_key,
    prd_num,
    ISNULL(prd_cost,0) AS prd_cost,
    CASE 
        WHEN TRIM(UPPER(prd_line)) = 'M' THEN 'Mountain'
        WHEN TRIM(UPPER(prd_line)) = 'S' THEN 'Other sales'
        WHEN TRIM(UPPER(prd_line)) = 'R' THEN 'Road'
        WHEN TRIM(UPPER(prd_line)) = 'T' THEN 'Touring'
        ELSE 'n/a'
    END AS prd_line,
    CAST(prd_start_dt AS DATE) AS prd_start_dt,
    CAST(
        DATEADD(
            DAY,
            -1,
            LEAD(prd_start_dt) OVER (PARTITION BY prd_key ORDER BY prd_start_dt)
        ) 
    AS DATE) AS prd_end_dt
FROM Bronze.cust_prd_info;


PRINT 'Truncating table Silver.cust_sales_details'
TRUNCATE TABLE Silver.cust_sales_details
PRINT ' Inserting Data Into Table : Silver.cust_sales_details'


INSERT INTO silver.cust_sales_details (

sales_ord,
sls_prd_key,
sls_cust_id,
sls_order_dt,
sls_ship_dt,
sls_due_dt,
sls_sales,
sls_quantity,
sls_price
)
SELECT 
sales_ord,
sls_prd_key,
sls_cust_id,
CAST(CASE WHEN sls_order_dt = 0 or LEN(sls_order_dt) != 8 THEN NULL
ELSE sls_order_dt END as DATE ) as sls_order_dt,
CAST(CASE WHEN sls_ship_dt = 0 or LEN(sls_ship_dt) != 8 THEN NULL
ELSE sls_ship_dt END as DATE ) as sls_ship_dt,
CAST(CASE WHEN sls_due_dt = 0 or LEN(sls_due_dt) != 8 THEN NULL
ELSE sls_due_dt END as DATE ) as sls_due_dt,
CASE 
    WHEN TRY_CONVERT(INT, sls_sales) IS NULL
         OR TRY_CONVERT(INT, sls_sales) <= 0
         OR TRY_CONVERT(INT, sls_sales) != (TRY_CONVERT(INT, sls_price) * TRY_CONVERT(INT, sls_quantity))
    THEN ABS(TRY_CONVERT(INT, sls_price) * TRY_CONVERT(INT, sls_quantity))
    ELSE ABS(TRY_CONVERT(INT, sls_sales))
END AS sls_sales,
sls_quantity,
CASE 
    WHEN TRY_CONVERT(INT, sls_price) IS NULL
         OR TRY_CONVERT(INT, sls_price) <= 0
    THEN 
         NULLIF(TRY_CONVERT(INT, sls_quantity),0)
         *
         TRY_CONVERT(INT, sls_sales)
    ELSE 
         TRY_CONVERT(INT, sls_price)
END AS sls_price
FROM Bronze.cust_sales_details


PRINT 'Truncating table erp_cust_az12'
TRUNCATE TABLE Silver.erp_cust_az12
PRINT ' Inserting Data Into Table : Silver.erp_cust_az12'


INSERT INTO Silver.erp_cust_az12 (
cid,
bdate,
gender

)


SELECT
CASE 
	WHEN cid like 'NAS%' THEN 
	SUBSTRING(cid,4,LEN(cid)) ELSE cid END as cid,
CASE 
	WHEN bdate > GETDATE() THEN NULL 
	ELSE bdate END AS bdate,
CASE 
	WHEN gender = 'M' THEN 'Male'
	WHEN gender = 'F' THEN 'Female'
	WHEN gender IS NULL THEN 'n/a'
	ELSE gender END AS gender
FROM Bronze.erp_cust_az12



PRINT 'Truncating table Silver.erp_loc_a101'
TRUNCATE TABLE Silver.erp_loc_a101
PRINT ' Inserting Data Into Table : Silver.erp_loc_a101'



INSERT INTO Silver.erp_loc_a101 (
l_cid,
cntry
)
SELECT 
REPLACE(l_cid,'-','') AS l_cid,
CASE
	WHEN TRIM(cntry) IN ('USA','US') THEN 'United states'
	WHEN TRIM(cntry) = 'DE' THEN 'Germany'
	WHEN cntry IS NULL THEN 'n/a'
	ELSE TRIM(cntry )
	END AS cntry
FROM Bronze.erp_loc_a101

PRINT 'Truncating table Silver.erp_px_cat12'
TRUNCATE TABLE Silver.erp_px_cat12
PRINT ' Inserting Data Into Table : Silver.erp_px_cat12'

INSERT INTO Silver.erp_px_cat12(

id,
cat,
subcat,
maintenance
)

SELECT 
id,
cat,
subcat,
maintenance
FROM Bronze.erp_px_cat12

END
